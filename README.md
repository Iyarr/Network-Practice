# ネットワーク学習用コンテナ構築

## 目的

ネスぺに向けた技術を学習するためのネットワーク構成を Docker コンテナで構築したい

## 学習したい内容

### ルーティングプロトコル

- RIP
- OSPF
- BGP
- MPLS

### 仮想化

- SDN
- OpenFlow
- NAT
- NAPT

### セキュリティ

- IPsec
- VLAN
- VPN
- GRE
- SSL/TLS
- SSH

### 冗長化

- VRRP
- LAG
- STP

### その他

- QOS

## 使用するツール

### Docker

コンテナ型の仮想化技術でネットワーク層以上の技術を学習するのに使用する

### FRRouting

CISCO のルーターに似たコマンドの設定のよって Linux 上でルーターを構築できるパッケージ
このパッケージと Docker を併用して使用する

## 構築する中でつまずいたこと

### Docker コンテナを起動するとすぐに終了してしまう

Docker コンテナを起動するとすぐに終了してしまう問題が生じた
原因は CMD で指定したコマンドが終了するとコンテナ自体も終了してしまうからだった

#### Docker のプロセスの仕組み

Docker においてはコンテナ内の PID1 のプロセスが終了するとコンテナが停止してしまう
PID1 のプロセスは、全てのプロセスの直接的、又は間接的な親プロセスで子プロセスにリソースを継承させたり、操作をすることができる
そしてその PID1 のプロセスは Dockerfile で CMD にて指定する

> ちなみに CMD で指定したコマンドはバックグラウンドで実行されるのでコマンドに`&`をつける必要はない

#### 通常の Linux では

通常は systemctl コマンド等が使えるようになる /sbin/init プロセスが PID1 として常時実行されている
Docker のコンテナ内ではこのプロセスが動作しないため、systemctl コマンド等が使えない

#### コンテナを起動し続ける工夫

色々なサイトによると、終了しないコマンドを指定することでコンテナを起動し続けることができると書かれていた

```Dockerfile
CMD ["tail", "-f", "/dev/null"]
```

ただこれだけだとコンテナ内のプロセスは何も動作しないので FRRouting のセットアップをする処理が実行できない

#### 解決策

シェルスクリプトを作成し、それを CMD で実行する
スクリプトの最後で`tail  -f /dev/null`コマンドを実行することでコンテナを起動し続けることができる

```Dockerfile
COPY ./frr.init /root/frr.init
CMD ["~/frr.init", "start"]
```

~/frr.init

```Bash
# FRRouting のインストール、初期設定など
tail -f /dev/null
```

### FRRouting の起動ができない

公式サイトによると以下のコマンドによって FRRouting を起動できると書かれていた

```bash
systemctl start frr
```

しかし、Docker コンテナ内でデーモンの操作は出来ないため、このような方法による起動はできない

#### 解決策

公式サイトによると systemctl 等でデーモンを操作するのではなく、デーモンを起動する際の初期化スクリプトを手動で実行することで FRRouting を起動できる

```Bash
/etc/init.d/frr start
```

最終的にこれをシェルスクリプトに記述し、それを CMD で実行することで FRRouting を起動できるようになった

### FRRouting の設定方法

FRRouting の設定をコンテナ起動時に自動で実行させるための方法を模索した

#### /etc/frr/frr.conf に設定を記述

設定用のファイルに設定を直接書きこみ、コンテナを起動する際に読み込むようにする方法
手動で設定を一回確認しながら入力していき、最終的にファイルに書き込む

手動の設定を /etc/frr/frr.conf ファイルに反映したいとき配下のコマンドを使用する
（vtysh 内では `write integrated` コマンドを使用する）

```bash
vtysh -w
```

この場合は実際に使ってみて設定の設定が frr.conf ファイルに反映されなかった

#### Lua で設定を記述

Lua というプログラミング言語を使用して設定を読み込ませる方法。
言語の難易度自体は高くないが、あまり慣れていないやり方になる

#### copy コマンドによる設定ファイルのコピー

vtysh で`copy /file running-config`コマンドを使用することで`/file`に指定したファイルに書かれている設定を反映させるコマンド

```bash
# /root/frr.init に設定内容を記述
echo "hostname router0" >> /root/frr.init
# 設定内容を反映
vtysh -c "copy /root/frr.conf running-config"
```
